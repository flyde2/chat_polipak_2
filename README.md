## 1 Основные эндпоинты

### 1.1 Чаты

1. **GET** `'/chats/'`  
   - Отдаёт список чатов для текущего аутентифицированного пользователя.  
   - Менеджер видит все чаты, где он является `manager`.  
   - Клиент видит все чаты, где он является `client`.  

2. **POST** `'/chats/'`  
   - Создаёт новый чат (только если текущий пользователь — менеджер).  
   - Параметр в теле:
     ```json
     {
       "client": <client_user_id>
     }
     ```
   - Поля `manager` и `created_at` заполняются автоматически.

3. **GET** `'/chats/<chat_id>/'`  
   - Просмотр конкретного чата (детали).  

4. **DELETE / PATCH / PUT** `'/chats/<chat_id>/'`  
   - По умолчанию `ModelViewSet` даёт доступ к обновлению и удалению, но логику разрешений можно расширять при необходимости.

### 1.2 Сообщения
1. **GET** `'/chats/<chat_id>/messages/'`  
   - Получение списка сообщений в заданном чате.  
   - Все сообщения, отправленные **не** текущим пользователем, автоматически отмечаются как прочитанные.

2. **POST** `'/chats/<chat_id>/messages/'`  
   - Создание нового сообщения.  
   - Тело запроса:
     ```json
     {
       "text": "любая строка для сообщения"
     }
     ```
   - Поле `chat` устанавливается автоматически в `perform_create` (не нужно передавать его в теле).  
   - Поле `sender` задаётся текущим пользователем.  

3. **GET / PATCH / PUT / DELETE** `'/chats/<chat_id>/messages/<message_id>/'`  
   - По умолчанию доступно чтение, обновление и удаление, логику можно расширить `ModelViewSet`.  
   - Доступ только участникам чата (проверка через `IsParticipant`).

### 1.3 Прочие эндпоинты

1. **GET** '/chats/total_unread_count/'  
   - Возвращает общее количество непрочитанных сообщений для текущего пользователя.  
   - Если пользователь — менеджер, то возвращается количество непрочитанных сообщений, отправленных клиентами.  
   - Если пользователь — клиент, то возвращается количество непрочитанных сообщений, отправленных менеджером.  
   - Ответ в формате:
   ```json
     {
       "unread_count": <число_непрочитанных_сообщений>
     }
   ```

---

## Роли и разрешения (permissions)

- **Profile.role**:  
  - `manager`  
  - `client`  
- **IsParticipant**: Гарантирует, что пользователь может получить доступ только к тому чату (и сообщениям в нём), в котором он либо менеджер, либо клиент.

При создании чата проверяется:
- Текущий пользователь должен быть менеджером.
- `client` в запросе должен иметь роль `client`.
- Если чат между этими двумя пользователями уже существует, возвращается ошибка (400).

---

## Тестирование

### Запуск тестов
```bash
python manage.py test
```
Файл `tests.py` содержит юнит-тесты, проверяющие бизнес-логику:
- Менеджер может создать чат.
- Клиент не может создать чат.
- Менеджер видит только свои чаты.
- Сценарии отправки сообщений (клиент, менеджер).
- Пометка непрочитанных сообщений как прочитанных при получении списка.
- Получение количества непрочитанных сообщений